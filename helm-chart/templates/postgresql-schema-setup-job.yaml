{{- if and .Values.postgresql.enabled .Values.postgresql.schema.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "uiuc-chat.fullname" . }}-database-schema
  labels:
    {{- include "uiuc-chat.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
data:
  schema.sql: |
    -- PostgreSQL database schema for UIUC Chat
    -- This schema includes the core tables needed for the application
    
    -- Create the main conversation monitoring table
    CREATE TABLE IF NOT EXISTS public."llm-convo-monitor" (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        convo json,
        convo_id text,
        course_name text,
        user_email text,
        summary text,
        convo_analysis_tags jsonb
    );
    
    -- Create primary key and unique constraints
    ALTER TABLE ONLY public."llm-convo-monitor"
        ADD CONSTRAINT "llm-convo-monitor_pkey" PRIMARY KEY (id);
    
    ALTER TABLE ONLY public."llm-convo-monitor"
        ADD CONSTRAINT "llm-convo-monitor_convo_id_key" UNIQUE (convo_id);
    
    -- Create indexes for better performance
    CREATE INDEX IF NOT EXISTS idx_llm_convo_monitor_course_name ON public."llm-convo-monitor" (course_name);
    CREATE INDEX IF NOT EXISTS idx_llm_convo_monitor_user_email ON public."llm-convo-monitor" (user_email);
    CREATE INDEX IF NOT EXISTS idx_llm_convo_monitor_created_at ON public."llm-convo-monitor" (created_at);
    
    -- Create documents table
    CREATE TABLE IF NOT EXISTS public.documents (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        filename text,
        file_path text,
        file_size bigint,
        file_type text,
        status text DEFAULT 'pending',
        content text,
        metadata jsonb
    );
    
    ALTER TABLE ONLY public.documents
        ADD CONSTRAINT documents_pkey PRIMARY KEY (id);
    
    -- Create document groups table
    CREATE TABLE IF NOT EXISTS public.doc_groups (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        group_name text,
        description text,
        status text DEFAULT 'active'
    );
    
    ALTER TABLE ONLY public.doc_groups
        ADD CONSTRAINT doc_groups_pkey PRIMARY KEY (id);
    
    -- Create documents_failed table
    CREATE TABLE IF NOT EXISTS public.documents_failed (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        filename text,
        error_message text,
        retry_count integer DEFAULT 0
    );
    
    ALTER TABLE ONLY public.documents_failed
        ADD CONSTRAINT documents_failed_pkey PRIMARY KEY (id);
    
    -- Create documents_in_progress table
    CREATE TABLE IF NOT EXISTS public.documents_in_progress (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        filename text,
        started_at timestamp with time zone DEFAULT now()
    );
    
    ALTER TABLE ONLY public.documents_in_progress
        ADD CONSTRAINT documents_in_progress_pkey PRIMARY KEY (id);
    
    -- Create additional tables from the original schema
    CREATE TABLE IF NOT EXISTS public."llm-guided-contexts" (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        context_name text,
        context_content text,
        metadata jsonb
    );
    
    ALTER TABLE ONLY public."llm-guided-contexts"
        ADD CONSTRAINT "llm-guided-contexts_pkey" PRIMARY KEY (id);
    
    CREATE TABLE IF NOT EXISTS public."llm-guided-docs" (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        doc_name text,
        doc_content text,
        doc_type text,
        metadata jsonb
    );
    
    ALTER TABLE ONLY public."llm-guided-docs"
        ADD CONSTRAINT "llm-guided-docs_pkey" PRIMARY KEY (id);
    
    CREATE TABLE IF NOT EXISTS public."llm-guided-sections" (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        section_name text,
        section_content text,
        section_type text,
        metadata jsonb
    );
    
    ALTER TABLE ONLY public."llm-guided-sections"
        ADD CONSTRAINT "llm-guided-sections_pkey" PRIMARY KEY (id);
    
    CREATE TABLE IF NOT EXISTS public.doc_groups_sharing (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        group_id bigint,
        user_email text,
        permission_level text DEFAULT 'read',
        shared_by text
    );
    
    ALTER TABLE ONLY public.doc_groups_sharing
        ADD CONSTRAINT doc_groups_sharing_pkey PRIMARY KEY (id);
    
    CREATE TABLE IF NOT EXISTS public.documents_doc_groups (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        document_id bigint,
        group_id bigint,
        created_at timestamp with time zone DEFAULT now()
    );
    
    ALTER TABLE ONLY public.documents_doc_groups
        ADD CONSTRAINT documents_doc_groups_pkey PRIMARY KEY (id);
    
    CREATE TABLE IF NOT EXISTS public.public_doc_groups (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        group_name text,
        description text,
        is_public boolean DEFAULT true
    );
    
    ALTER TABLE ONLY public.public_doc_groups
        ADD CONSTRAINT public_doc_groups_pkey PRIMARY KEY (id);
    
    CREATE TABLE IF NOT EXISTS public.cedar_documents (
        id bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
        created_at timestamp with time zone DEFAULT now(),
        course_name text,
        cedar_id text,
        document_name text,
        document_content text,
        metadata jsonb
    );
    
    ALTER TABLE ONLY public.cedar_documents
        ADD CONSTRAINT cedar_documents_pkey PRIMARY KEY (id);
    
    -- Create project stats function
    CREATE OR REPLACE FUNCTION public.update_project_stats()
    RETURNS trigger AS $$
    BEGIN
        -- This function can be extended to update project statistics
        -- when conversation data changes
        RETURN COALESCE(NEW, OLD);
    END;
    $$ LANGUAGE plpgsql;
    
    -- Create trigger for project stats
    DROP TRIGGER IF EXISTS project_stats_trigger ON public."llm-convo-monitor";
    CREATE TRIGGER project_stats_trigger 
        AFTER INSERT OR DELETE OR UPDATE ON public."llm-convo-monitor" 
        FOR EACH ROW EXECUTE FUNCTION public.update_project_stats();
    
    -- Grant permissions to postgres user
    GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO postgres;
    GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO postgres;
    
    -- Create additional indexes for performance
    CREATE INDEX IF NOT EXISTS idx_documents_course_name ON public.documents (course_name);
    CREATE INDEX IF NOT EXISTS idx_documents_status ON public.documents (status);
    CREATE INDEX IF NOT EXISTS idx_doc_groups_course_name ON public.doc_groups (course_name);
    
    -- Insert some sample data for testing (optional)
    INSERT INTO public."llm-convo-monitor" (course_name, user_email, convo_id, convo, summary)
    VALUES 
        ('demo', 'test@example.com', 'demo-convo-1', '{"messages": [{"role": "user", "content": "Hello"}]}', 'Test conversation')
    ON CONFLICT (convo_id) DO NOTHING;
    
    -- Log completion
    DO $$
    BEGIN
        RAISE NOTICE 'Database schema initialization completed successfully';
    END $$;
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "uiuc-chat.fullname" . }}-postgresql-schema-setup
  labels:
    {{- include "uiuc-chat.labels" . | nindent 4 }}
    app.kubernetes.io/component: database
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"  # Run before other services
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  template:
    metadata:
      labels:
        {{- include "uiuc-chat.labels" . | nindent 8 }}
        app.kubernetes.io/component: database
    spec:
      restartPolicy: OnFailure
      containers:
      - name: schema-setup
        image: postgres:16-alpine
        command:
        - /bin/bash
        - -c
        - |
          echo "Waiting for PostgreSQL to be ready..."
          until pg_isready -h {{ include "uiuc-chat.postgresql.host" . }} -p {{ include "uiuc-chat.postgresql.port" . }} -U {{ include "uiuc-chat.postgresql.username" . }}; do
            echo "PostgreSQL not ready yet, waiting..."
            sleep 5
          done
          
          echo "PostgreSQL is ready, applying database schema..."
          
          # Apply the schema
          PGPASSWORD={{ .Values.postgresql.auth.password }} psql \
            -h {{ include "uiuc-chat.postgresql.host" . }} \
            -p {{ include "uiuc-chat.postgresql.port" . }} \
            -U {{ include "uiuc-chat.postgresql.username" . }} \
            -d {{ include "uiuc-chat.postgresql.database" . }} \
            -f /schema/schema.sql
          
          if [ $? -eq 0 ]; then
            echo "Database schema applied successfully!"
          else
            echo "Failed to apply database schema"
            exit 1
          fi
          
          echo "Database schema setup completed successfully!"
        env:
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ include "uiuc-chat.fullname" . }}-postgresql
              key: postgres-password
        volumeMounts:
        - name: schema
          mountPath: /schema
      volumes:
      - name: schema
        configMap:
          name: {{ include "uiuc-chat.fullname" . }}-database-schema
{{- end }}
